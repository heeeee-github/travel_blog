<!DOCTYPE html>
<html>
<head>
    <title>{{ post.title }}</title>
</head>
<body>
    <h1>{{ post.title }}</h1>
    <p>{{ post.content }}</p>
    <p>카테고리: {{ post.category.name }}</p>
    <p>작성자: {{ post.author }}</p>
    <p>게시일: {{ post.created_at }}</p>
    <p>수정일: {{ post.updated_at }}</p>
    
    <h2>이미지</h2>
    {% for image in post.images.all %}
        <img src="{{ image.image.url }}" alt="Post Image" style="max-width: 100%; height: auto;">
    {% empty %}
        <p>이미지가 없습니다.</p>
    {% endfor %}

    <h2>비디오</h2>
    {% for video in post.videos.all %}
        <video controls style="max-width: 100%; height: auto;">
            <source src="{{ video.video.url }}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    {% empty %}
        <p>비디오가 없습니다.</p>
    {% endfor %}

    <h2>오디오</h2>
    {% for audio in post.audios.all %}
        <audio controls>
            <source src="{{ audio.audio.url }}" type="audio/mpeg">
            Your browser does not support the audio tag.
        </audio>
    {% empty %}
        <p>오디오가 없습니다.</p>
    {% endfor %}

    <h2>댓글</h2>
    <div>
        {% for comment in comments %}
            <p><strong>{{ comment.author }}</strong>: {{ comment.content }}</p>
            <p>작성일: {{ comment.created_at }}</p>
            {% if comment.author == request.user %}
                <a href="{% url 'comment_edit' comment.pk %}">수정</a>
                <a href="{% url 'comment_delete' comment.pk %}">삭제</a>
            {% endif %}

            <!-- 답글 작성 버튼 -->
            <a href="?reply_to={{ comment.pk }}">답글</a>

            <!-- 답글 폼 표시 -->
            {% if request.GET.reply_to == comment.pk|stringformat:"s" %}
                <form method="post" action="{% url 'comment_reply' %}">
                    {% csrf_token %}
                    <input type="hidden" name="post" value="{{ post.pk }}">
                    <input type="hidden" name="reply_to" value="{{ comment.pk }}">
                    <textarea name="content" required></textarea>
                    <button type="submit">답글 작성</button>
                </form>
            {% endif %}

            <!-- 답글 목록 -->
            <div class="replies">
                {% for reply in comment.replies.all %}
                    <div class="comment" style="margin-left: 20px;">
                        <p><strong>{{ reply.author }}</strong>: {{ reply.content }}</p>
                        <p>작성일: {{ reply.created_at }}</p>
                        {% if reply.author == request.user %}
                            <a href="{% url 'comment_edit' reply.pk %}">수정</a>
                            <a href="{% url 'comment_delete' reply.pk %}">삭제</a>
                        {% endif %}
                        <!-- 답글 작성 버튼 -->
                        <a href="?reply_to={{ reply.pk }}">답글</a>
            
                        <!-- 답글 폼 표시 -->
                        {% if request.GET.reply_to == comment.pk|stringformat:"s" %}
                            <form method="post" action="{% url 'comment_reply' %}">
                                {% csrf_token %}
                                <input type="hidden" name="post" value="{{ post.pk }}">
                                <input type="hidden" name="reply_to" value="{{ comment.pk }}">
                                <textarea name="content" required></textarea>
                                <button type="submit">답글 작성</button>
                            </form>
                        {% endif %}

                        <!-- 답글의 답글 목록 -->
                        <div class="replies">
                            {% for nested_reply in reply.replies.all %}
                                <div class="comment" style="margin-left: 40px;">
                                    <p><strong>{{ nested_reply.author }}</strong>: {{ nested_reply.content }}</p>
                                    <p>작성일: {{ nested_reply.created_at }}</p>
                                    {% if nested_reply.author == request.user %}
                                        <a href="{% url 'comment_edit' nested_reply.pk %}">수정</a>
                                        <a href="{% url 'comment_delete' nested_reply.pk %}">삭제</a>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
                <hr>
        {% endfor %}
    </div>

    {% if request.user.is_authenticated %}
        <h3>댓글 작성</h3>
        <form method="post">
            {% csrf_token %}
            {{ comment_form.as_p }}
            <button type="submit">댓글 달기</button>
        </form>
    {% else %}
        <p>댓글을 작성하려면 로그인하세요.</p>
    {% endif %}
    




    {% if post.author == request.user %}
        <a href="{% url 'post_update' post.pk %}">수정</a>
        <a href="{% url 'post_delete' post.pk %}">삭제</a>
    {% endif %}
    <a href="{% url 'post_list' %}">글 목록</a>
</body>
</html>